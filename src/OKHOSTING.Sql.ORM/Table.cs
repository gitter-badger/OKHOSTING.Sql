using System;
using System.Linq;
using System.Collections.Generic;
using OKHOSTING.Sql.ORM.Operations;
using OKHOSTING.Sql.ORM.Filters;

namespace OKHOSTING.Sql.ORM
{
	public class Table<TKey, TType>: Core.Data.DictionaryBase<TKey, TType>
	{
		public readonly DataBase DataBase;
		public readonly DataType DataType = typeof(TType);

		public override void Add(KeyValuePair<TKey, TType> item)
		{
			DataType dtype = item.Value.GetType();

			foreach (DataType parent in dtype.GetBaseDataTypes().Reverse())
			{
				Insert insert = new Insert();
				insert.Into = parent;

				foreach (DataMember dmember in parent.Members)
				{
					insert.Values.Add(new MemberValue(dmember, item.Value));
				}

				DataBase.Insert(insert);

				//get autoincrement id if this is the base table and on of the pk columns is autoincrement
				DataMember autoIncrementMember = parent.PrimaryKey.Where(pk => pk.Column.IsAutoNumber).FirstOrDefault();

				if (parent.BaseDataType == null && autoIncrementMember != null)
				{
					TKey autoincrement = (TKey) Convert.ChangeType(DataBase.NativeDataBase.GetScalar(DataBase.SqlGenerator.LastAutogeneratedId(parent.Table)), typeof(TKey));
					autoIncrementMember.SetValueFromColumn(item.Value, autoincrement);
				}
			}
		}

		public override bool ContainsKey(TKey key)
		{
			Select<TType> select = new Select<TType>();
			select.From = DataType;
			select.Members.Add(select.From.PrimaryKey.First());
			select.Where.Add(GetPrimaryKeyFilter(DataType, key));

			return DataBase.Select(select).Count() > 0;
		}

		public override IEnumerator<KeyValuePair<TKey, TType>> GetEnumerator()
		{
			Select<TType> select = CreateSelect();
			DataMember pkMember = select.From.PrimaryKey.First();
			
			foreach (TType instance in DataBase.Select(select))
			{
				TKey key = (TKey) Convert.ChangeType(pkMember.GetValue(instance), pkMember.ReturnType);
				yield return new KeyValuePair<TKey, TType>(key, instance);
			}
		}

		public override bool IsReadOnly
		{
			get 
			{
				return false; ; 
			}
		}

		public override ICollection<TKey> Keys
		{
			get 
			{
				Select<TType> select = new Select<TType>();
				select.From = DataType;
				select.Members.Add(select.From.PrimaryKey.First());

				List<TKey> keys = new List<TKey>();
				DataMember pk = select.From.PrimaryKey.First();

				foreach(TType instance in DataBase.Select(select))
				{
					keys.Add((TKey) pk.GetValue(instance));
				}

				return keys;
			}
		}

		public override bool Remove(TKey key)
		{
			int result = 0;

			//go from child to base class inheritance
			foreach (DataType parent in DataType.GetBaseDataTypes())
			{
				Delete delete = new Delete();
				delete.From = parent;
				delete.Where.Add(GetPrimaryKeyFilter(parent, key));

				result += DataBase.Delete(delete);
			}

			return result > 0;
		}

		public override TType this[TKey key]
		{
			get
			{
				Select<TType> select = CreateSelect();
				select.Where.Add(GetPrimaryKeyFilter(DataType, key));
				var result = DataBase.Select(select).ToList();

				if (result.Count > 0)
				{
					return result[0];
				}
				else
				{
					return default(TType);
				}
			}
			set
			{
				if (ContainsKey(key))
				{
					DataType dtype = value.GetType();

					foreach (DataType parent in dtype.GetBaseDataTypes().Reverse())
					{
						Update update = new Update();
						update.From = parent;

						//update everything but the primary key
						foreach (DataMember dmember in parent.Members.Where(m => !m.Column.IsPrimaryKey))
						{
							update.Set.Add(new MemberValue(dmember, value));
						}

						update.Where.Add(GetPrimaryKeyFilter(parent, key));

						DataBase.Update(update);
					}
				}
				else
				{
					Add(new KeyValuePair<TKey, TType>(key, value));
				}
			}
		}

		#region Non public

		internal Table(DataBase database)
		{
			DataBase = database;
		}

		protected virtual Filters.FilterBase GetPrimaryKeyFilter(DataType dtype, TKey key)
		{
			return new Filters.ValueCompareFilter()
			{
				Member = dtype.PrimaryKey.First(),
				ValueToCompare = (IComparable) key,
				Operator = Core.Data.CompareOperator.Equal,
			};
		}

		protected virtual Filters.FilterBase GetSelectJoinFilter(DataType dtype)
		{
			return new Filters.MemberCompareFilter()
			{
				Member = dtype.PrimaryKey.First(),
				MemberToCompare = dtype.BaseDataType.PrimaryKey.First(),
			};
		}

		/// <summary>
		/// Creates a select operation with all DataType's members and inheritance inner joins
		/// </summary>
		/// <returns>Select operation</returns>
		protected Select<TType> CreateSelect()
		{
			Select<TType> select = new Select<TType>();
			DataType dtype = DataType;
			select.From = dtype;
			Random random = new Random();

			foreach (DataMember member in dtype.Members)
			{
				select.Members.Add(new SelectMember(member, member.Member.Replace('.', '_') + random.Next()));
			}

			//go from child type to base type adding joins
			while (dtype.BaseDataType != null)
			{
				SelectJoin join = new SelectJoin();
				join.JoinType = Sql.Operations.SelectJoinType.Inner; //could change?
				join.Type = dtype.BaseDataType;
				join.On.Add(GetSelectJoinFilter(dtype));

				//exclude primary key from base tables, to avoid duplicate values
				foreach (DataMember member in dtype.BaseDataType.Members.Where(m => !m.Column.IsPrimaryKey))
				{
					select.Members.Add(new SelectMember(member, member.Member.Replace('.', '_') + random.Next()));
				}

				select.Joins.Add(join);
				dtype = dtype.BaseDataType;
			}

			return select;
		}

		#endregion
	}
}